description: Setup Redmine
parameters:
  db:
    description: Database
    type: string
  redmine_version:
    description: version of Redmine
    type: string
  ruby_version:
    description: version of Ruby
    type: string
steps:
  - restore_cache:
      keys:
        - '{{ .Environment.CACHE_VERSION }}-redmine-setup-<< parameters.ruby_version >>-<< parameters.redmine_version >>-<< parameters.db >>-{{ checksum "Gemfile.local" }}'
  - run:
      name: Setup Redmine << parameters.redmine_version >>
      working_directory: ~/redmine-<< parameters.redmine_version >>
      command: |
        bundle check || bundle install --without development rmagick
  - save_cache:
      key: '{{ .Environment.CACHE_VERSION }}-redmine-setup-<< parameters.ruby_version >>-<< parameters.redmine_version >>-<< parameters.db >>-{{ checksum "Gemfile.local" }}'
      paths:
        - ~/.bundle
        - ~/redmine-<< parameters.redmine_version >>/Gemfile.lock
  - run:
      name: Setup Database
      working_directory: ~/redmine-<< parameters.redmine_version >>
      command: |
        bundle exec rake db:create db:migrate
  - run:
      name: Setup plugins
      working_directory: ~/redmine-<< parameters.redmine_version >>
      command: |
        bundle exec rake redmine:plugins

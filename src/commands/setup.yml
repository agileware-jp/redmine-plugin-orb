description: Setup Redmine
parameters:
  cache_key_prefix:
    description: prefix of cache key
    type: string
    default: redmine-plugin-commands-setup-
steps:
  - run:
      name: Check ruby version
      command: |
        ruby -v > /tmp/ruby-version
  - restore_cache:
      keys:
        - '<< parameters.cache_key_prefix >>{{ checksum "/tmp/ruby-version" }}-{{ checksum "Gemfile" }}-{{ checksum "config/database.yml" }}'
  - run:
      name: Setup Redmine
      command: |
        bundle check --path vendor/bundle || bundle install --path vendor/bundle
  - save_cache:
      key: '<< parameters.cache_key_prefix >>{{ checksum "/tmp/ruby-version" }}-{{ checksum "Gemfile" }}-{{ checksum "config/database.yml" }}'
      paths:
        - vendor/bundle
        - Gemfile.lock
  - run:
      name: Setup Database
      command: |
        bundle exec rake db:create db:migrate
  - run:
      name: Setup plugins
      command: |
        bundle exec rake redmine:plugins

parameters:
  after-script:
    description: steps to execute after script
    type: steps
    default:
      - persist_to_workspace:
          root: ~/project
          paths: ['*']
  before-script:
    description: steps to execute before script
    type: steps
    default: []
  before-setup:
    description: steps to execute before setup
    type: steps
    default: []
  cache_key_prefix:
    description: key of cache
    type: string
    default: ''
  executor:
    description: executor for rspec
    type: executor
  plugin_name:
    description: name of Redmine plugin
    type: string
    default: ''
  redmine_version:
    description: version of Redmine
    type: string
  script:
    description: steps to execute the rspec
    type: steps
    default:
      - copy-rspec-config:
          plugin_name: << parameters.plugin_name >>
      - run: |
          if [ -z "$REDMINE_PLUGIN_NAME" ]; then
            REDMINE_PLUGIN_NAME=$CIRCLE_PROJECT_REPONAME
          fi
          bundle exec rspec plugins/$REDMINE_PLUGIN_NAME/spec
  workspace_path:
    description: path of attached workspace
    type: string
    default: /tmp/workspace

environment:
  RAILS_ENV: test
  REDMINE_PLUGIN_NAME: << parameters.plugin_name >>
  WORKSPACE_PATH: << parameters.workspace_path >>

executor: << parameters.executor >>

steps:
  - attach_workspace:
      at: << parameters.workspace_path >>
  - download:
      cache_key_prefix: << parameters.cache_key_prefix >>
      redmine_version: << parameters.redmine_version >>
      destination: ~/project
  - install-plugin:
      copy_gemfile_to: /tmp/Gemfile
      plugin_name: << parameters.plugin_name >>
  - generate-database_yml
  - steps: << parameters.before-setup >>
  - setup:
      cache_key_prefix: << parameters.cache_key_prefix >>{{ checksum "/tmp/Gemfile" }}
  - steps: << parameters.before-script >>
  - steps: << parameters.script >>
  - steps: << parameters.after-script >>

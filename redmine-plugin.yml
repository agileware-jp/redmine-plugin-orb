version: 2.1

commands:
  download:
    description: Download Redmine << parameters.redmine_version >>
    parameters:
      redmine_version:
        description: version of Redmine
        type: string
    steps:
      - restore_cache:
          keys:
            - '{{ .Environment.CACHE_VERSION }}-redmine-download-<< parameters.redmine_version >>'
      - run:
          name: Download Redmine << parameters.redmine_version >>
          working_directory: '~/'
          command: |
            set -e
            if [ ! -d ~/redmine-<< parameters.redmine_version >> ]; then
              curl https://redmine.org/releases/redmine-<< parameters.redmine_version >>.tar.gz | tar zx
            fi
      - save_cache:
          key: '{{ .Environment.CACHE_VERSION }}-redmine-download-<< parameters.redmine_version >>'
          paths: ~/redmine-<< parameters.redmine_version >>
  install_plugin:
    description: Install Redmine plugin << parameters.redmine_plugin_repository >>
    parameters:
      redmine_version:
        description: version of Redmine
        type: string
      redmine_plugin_repository:
        description: repository of Redmine plugin
        type: string
    steps:
      - run:
          name: Install plugin << parameters.redmine_plugin_repository >>
          working_directory: ~/redmine-<< parameters.redmine_version >>/plugins
          command: |
            git clone --depth 1 << parameters.redmine_plugin_repository >>
  setup:
    description: Setup Redmine
    parameters:
      db:
        description: Database
        type: string
      redmine_version:
        description: version of Redmine
        type: string
      ruby_version:
        description: version of Ruby
        type: string
    steps:
      - restore_cache:
          keys:
            - '{{ .Environment.CACHE_VERSION }}-redmine-setup-<< parameters.ruby_version >>-<< parameters.redmine_version >>-<< parameters.db >>-{{ checksum "Gemfile.local" }}'
      - run:
          name: Setup Redmine << parameters.redmine_version >>
          working_directory: ~/redmine-<< parameters.redmine_version >>
          command: |
            bundle check || bundle install --without development rmagick
      - save_cache:
          key: '{{ .Environment.CACHE_VERSION }}-redmine-setup-<< parameters.ruby_version >>-<< parameters.redmine_version >>-<< parameters.db >>-{{ checksum "Gemfile.local" }}'
          paths:
            - ~/.bundle
            - ~/redmine-<< parameters.redmine_version >>/Gemfile.lock
      - run:
          name: Setup Database
          working_directory: ~/redmine-<< parameters.redmine_version >>
          command: |
            bundle exec rake db:create db:migrate
      - run:
          name: Setup plugins
          working_directory: ~/redmine-<< parameters.redmine_version >>
          command: |
            bundle exec rake redmine:plugins

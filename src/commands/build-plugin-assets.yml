description: Run yarn build to build plugin assets (requires Docker)

parameters:
  cache_key_prefix:
    description: Prefix of cache key
    type: string
    default: redmine-plugin-build-cache-
  plugin_folder:
    description: Plugin folder
    type: string

steps:
  - restore_cache:
      keys:
        - '<< parameters.cache_key_prefix >><< parameters.plugin_folder >>-{{ checksum ".node-version" }}-{{ checksum "yarn.lock" }}'
  - run:
      name: Install dependencies
      working_directory: '<< parameters.plugin_folder >>'
      command: |
        if [ ! -d node_modules ]; then
          docker run -u root -v `pwd`:/plugin -w /plugin circleci/node:`cat .node-version` yarn install
        fi
  - save_cache:
      key: '<< parameters.cache_key_prefix >><< parameters.plugin_folder >>-{{ checksum ".node-version" }}-{{ checksum "yarn.lock" }}'
      paths:
        - '<< parameters.plugin_folder >>/node_modules'
  - run:
      name: Build assets
      working_directory: '<< parameters.plugin_folder >>'
      command: docker run -u root -v `pwd`:/plugin -w /plugin circleci/node:`cat .node-version` yarn build

parameters:
  before-setup:
    description: steps to execute before setup
    type: steps
    default: []
  cache_key_prefix:
    description: key of cache
    type: string
    default: ''
  executor:
    description: executor for test
    type: executor
  plugin_name:
    description: name of Redmine plugin
    type: string
    default: ''
  script:
    description: steps to execute the test
    type: steps
    default:
      - run: |
          if [ -n "$REDMINE_PLUGIN_NAME" ]; then
            bin/rails redmine:plugins:test NAME=$REDMINE_PLUGIN_NAME
          else
            bin/rails redmine:plugins:test NAME=$CIRCLE_PROJECT_REPONAME
          fi

environment:
  RAILS_ENV: test
  REDMINE_PLUGIN_NAME: << parameters.plugin_name >>

executor: << parameters.executor >>

working_directory: /tmp/workspace/redmine

steps:
  - attach_workspace:
      at: '/tmp/workspace'
  - checkout:
      path: /tmp/plugin
  - run:
      name: Install plugin
      command: |
        if [ -n "$REDMINE_PLUGIN_NAME" ]; then
          ln -s /tmp/plugin plugins/$REDMINE_PLUGIN_NAME
        else
          ln -s /tmp/plugin plugins/$CIRCLE_PROJECT_REPONAME
        fi
  - steps: << parameters.before-setup >>
  - setup:
      cache_key_prefix: << parameters.cache_key_prefix >>{{ checksum "/tmp/plugin/Gemfile" }}
  - steps: << parameters.script >>

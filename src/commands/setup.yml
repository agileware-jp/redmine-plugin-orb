description: Setup Redmine
parameters:
  cache_key_prefix:
    description: prefix of cache key
    type: string
    default: redmine-plugin-commands-setup
steps:
  - restore_cache:
      keys:
        - '<< parameters.cache_key_prefix >>-{{ checksum "Gemfile" }}'
  - run:
      name: Setup Redmine
      command: |
        bundle check || bundle install --without development rmagick
  - save_cache:
      key: '<< parameters.cache_key_prefix >>-{{ checksum "Gemfile" }}'
      paths:
        - ~/.bundle
        - Gemfile.lock
  - run:
      name: Setup Database
      command: |
        bundle exec rake db:create db:migrate
  - run:
      name: Setup plugins
      command: |
        bundle exec rake redmine:plugins
